# Гайд по маскам суб-биомов

## Что такое маска?
Маска (`mask`) — это **8-битное число** (0–255), которое кодирует направления **чужих** биомов вокруг текущего тайла.

Каждый бит отвечает за одно из 8 направлений:

```
Биты маски (byte 0-255):

  TL(1)   T(2)   TR(4)
    ╲      |      ╱
     ╲     |     ╱
L(16) ←  TILE  → R(32)
     ╱     |     ╲
    ╱      |      ╲
  BL(64)  B(8)  BR(128)

TL = Top-Left    = 1
T  = Top         = 2
TR = Top-Right   = 4
L  = Left        = 16
R  = Right       = 32
BL = Bottom-Left = 64
B  = Bottom      = 8
BR = Bottom-Right= 128
```

## Примеры основных масок

### Маска = 0
**Все соседи** того же биома → **суб-биом НЕ создаётся** (внутренний тайл).

---

### Маска = 2 (TOP)
```
  [FOREST]  ← другой биом сверху
     |
  [PLAINS]  ← текущий тайл
```
Переход сверху. **Спрайт**: горизонтальная граница (верх).

---

### Маска = 8 (BOTTOM)
```
  [PLAINS]  ← текущий тайл
     |
  [FOREST]  ← другой биом снизу
```
Переход снизу. **Спрайт**: горизонтальная граница (низ).

---

### Маска = 16 (LEFT)
```
[FOREST] ← [PLAINS]
           текущий тайл
```
Переход слева. **Спрайт**: вертикальная граница (лево).

---

### Маска = 32 (RIGHT)
```
[PLAINS] → [FOREST]
текущий     другой биом
```
Переход справа. **Спрайт**: вертикальная граница (право).

---

### Маска = 3 (TOP + TOP_LEFT = 2+1)
```
[F] [F]     (F = другой биом, P = текущий)
     |
  [P]
```
Угловой переход: верх и верхний левый угол. **Спрайт**: внешний угол (top-left).

---

### Маска = 6 (TOP + TOP_RIGHT = 2+4)
```
[F] [F]
 |
[P]
```
Угловой переход: верх и верхний правый угол. **Спрайт**: внешний угол (top-right).

---

### Маска = 7 (TOP + TOP_LEFT + TOP_RIGHT = 2+1+4)
```
[F] [F] [F]
     |
  [P]
```
Широкий верхний переход (три соседа сверху). **Спрайт**: широкая верхняя граница.

---

### Маска = 15 (TOP + BOTTOM + LEFT + TOP_LEFT = 2+8+16+1)
```
  [F] [F]
   |   |
[F]→[P]
   |
  [F]
```
Множественные направления. **Спрайт**: сложная переходная текстура (несколько граней).

---

### Маска = 31 (все кардинальные + некоторые диагонали)
```
[F] [F] [F]
[F] [P] [F]
    [F]
```
Почти окружён. **Спрайт**: "островок" другого биома.

---

### Маска = 63 (верх + лево + право + диагонали сверху + низ)
```
[F] [F] [F]
[F] [P] [F]
    [F]
```
Почти полное окружение (не хватает нижних диагоналей). **Спрайт**: узкий проход.

---

### Маска = 127 (все кроме BR = 255 - 128)
```
[F] [F] [F]
[F] [P] [F]
[F] [F]
```
Почти полностью окружен (кроме нижнего правого угла). **Спрайт**: узкий выход.

---

### Маска = 255 (все 8 направлений)
```
[F] [F] [F]
[F] [P] [F]
[F] [F] [F]
```
Полностью окружён чужим биомом. **Спрайт**: центральный "остров" — полная переходная текстура.

---

## Какой спрайт назначать?

### Простые (одна сторона)
- **mask = 2, 8, 16, 32**: прямые грани (top, bottom, left, right)

### Углы (две смежные стороны)
- **mask = 3, 6, 12, 24, 48, 96, 192, 129**: внешние углы

### Широкие переходы (три стороны)
- **mask = 7, 14, 28, 56, 112, etc.**: полосы с несколькими гранями

### Сложные переходы (четыре+ стороны)
- **mask = 15, 31, 63, 127, 255**: множественные границы или полное окружение

---

## Рекомендации по созданию спрайтов

1. **Минимальный набор** (самые частые):
   - `sub_{biome}_2` — верх
   - `sub_{biome}_8` — низ
   - `sub_{biome}_16` — лево
   - `sub_{biome}_32` — право
   - `sub_{biome}_3` — угол top-left
   - `sub_{biome}_6` — угол top-right
   - `sub_{biome}_12` — угол bottom-left
   - `sub_{biome}_24` — угол bottom-right
   - `sub_{biome}_255` — полное окружение

2. **Расширенный набор** (для плавных переходов):
   - Добавь `7, 15, 31, 63, 127` для сложных форм границ.

3. **Fallback**:
   - Если спрайт для конкретной маски отсутствует, `TileSpriteDB` откатывается на базовый `sub_{biome}` (можно сделать универсальную переходную текстуру).

---

## Логика генерации

### Когда создаётся суб-биом?
Суб-биом появляется **только на первом ряду тайлов** границы с другим биомом:

1. Текущий тайл имеет `biomeId` = "plains".
2. Сосед (хотя бы один кардинальный: N/S/E/W) имеет `biomeId` = "forest".
3. `GetDominantNeighbor` возвращает "forest".
4. `GetMask` вычисляет направления чужих биомов → маска != 0.
5. **Проверка кардинальной границы**: хотя бы один из соседей N/S/E/W = "forest".
6. → Создаётся `sub_forest_{mask}`.

### Пример сценария:
```
Координаты:   (1,1)    (1,2)    (1,3)
Биомы:        forest   plains   plains
```

**Тайл (1,2)**:
- `biomeId` = "plains"
- Кардинальный сосед слева (1,1) = "forest"
- `dominant` = "forest"
- `mask` = 16 (LEFT)
- → `sub_forest_16` добавляется к (1,2)

**Тайл (1,3)**:
- `biomeId` = "plains"
- Кардинальные соседи: все "plains"
- Нет кардинального соседа "forest"
- → Суб-биом НЕ создаётся ✅

---

## Итог
- **Маска** определяет **направления** других биомов вокруг тайла.
- **Спрайт** должен визуально показывать переход в этих направлениях.
- **Суб-биом появляется только на первом ряду** границы (кардинальное соприкосновение).
- **Без кардинального соседа dominant** → суб-биом не создаётся (решает проблему глубоких спаунов).

---

**Дата создания**: 2025-11-29  
**Автор**: GitHub Copilot (по запросу пользователя)
